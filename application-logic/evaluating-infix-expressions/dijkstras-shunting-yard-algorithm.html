<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dijkstra&#x27;s Shunting Yard Algorithm - How I Built freeCodeCamp&#x27;s Calculator with Elm</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">How I Built freeCodeCamp&#x27;s Calculator with Elm</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dijkstras-shunting-yard-algorithm"><a class="header" href="#dijkstras-shunting-yard-algorithm">Dijkstra's Shunting Yard Algorithm</a></h1>
<h2 id="algorithm"><a class="header" href="#algorithm">Algorithm</a></h2>
<p>The following pseudocode describes an algorithm, based on <a href="https://en.wikipedia.org/wiki/Shunting_yard_algorithm">Dijkstra's shunting yard algorithm</a>, for evaluating infix expressions. It assumes that the infix expression has already been <a href="#tokenization">tokenized</a>.</p>
<pre><code class="language-txt">eval(tokens: List of Token) -&gt; Rational or Error
  -- Initialization

  operands = Stack.empty()
  operators = Stack.empty()

  -- Process the tokens

  for t in tokens do
    if t is a number, n then
      operands.push(n)

    else if t is an operator, op1 then
      -- Evaluate the dominant operators

      while operators.isNotEmpty() do
        op2 = operators.top()

        if precendence(op2) &gt;= precendence(op1) then
          op2 = operators.pop()
          evalBinOp(op2, operands)

        else
          break
        end if
      end while

      operators.push(op1)
    end if
  end for

  -- Process the operators

  while operators.isNotEmpty() do
    op = operators.pop()
    evalBinOp(op, operands)
  end while

  -- Return the value

  if operands.isEmpty() then
    raise an error
  end if

  value = operands.pop()

  if operands.isEmpty() then
    return value

  else
    raise an error
  end if
end

evalBinOp(op: Operator, operands: Stack of Rational) -&gt; () or Error
  if operands.isEmpty() then
    raise an error
  end if

  b = operands.pop()

  if operands.isEmpty() then
    raise an error
  end if

  a = operands.pop()

  if op is addition then
    operands.push(a + b)

  else if op is subtraction then
    operands.push(a - b)

  else if op is multiplication then
    operands.push(a × b)

  else if op is division then
    operands.push(a ÷ b)
  end if
end
</code></pre>
<h2 id="tokenization"><a class="header" href="#tokenization">Tokenization</a></h2>
<p>The infix expression <code>1 + 9 - 17 × 3 ÷ 4</code> would be tokenized as follows:</p>
<pre><code class="language-elm">[ Number (Rational.fromInt 1)
, Operand Add
, Number (Rational.fromInt 9)
, Operand Sub
, Number (Rational.fromInt 17)
, Operand Mul
, Number (Rational.fromInt 3)
, Operand Div
, Number (Rational.fromInt 2)
]
</code></pre>
<h2 id="precedence"><a class="header" href="#precedence">Precedence</a></h2>
<p>The precendence of the supported operators are as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Operator</th><th>Precedence</th></tr></thead><tbody>
<tr><td><code>Add</code></td><td><code>1</code></td></tr>
<tr><td><code>Sub</code></td><td><code>1</code></td></tr>
<tr><td><code>Mul</code></td><td><code>2</code></td></tr>
<tr><td><code>Div</code></td><td><code>2</code></td></tr>
</tbody></table>
</div>
<p><code>Add</code> and <code>Sub</code> have the same level but lower precedence than <code>Mul</code> and <code>Div</code>. All the supported operators are left-associative so we don't have to deal with associativity. However, if we decide to add exponentiation, which is right-associative, then we'd have to start considering associativity.</p>
<p>The corresponding <code>precedence</code> function can be implemented as follows:</p>
<pre><code class="language-elm">precedence : Operator -&gt; Int
precedence op =
    case op of
        Add -&gt;
            1

        Sub -&gt;
            1

        Mul -&gt;
            2

        Div -&gt;
            2
</code></pre>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>These examples are here to help you understand the algorithm.</p>
<h3 id="example-1"><a class="header" href="#example-1">Example 1</a></h3>
<p>Input: <code>3</code></p>
<div class="table-wrapper"><table><thead><tr><th>Token</th><th>Action</th><th>Operands</th><th>Operators</th><th>Value</th></tr></thead><tbody>
<tr><td><code>3</code></td><td>Push <code>3</code> to operands</td><td><code>[ 3 ]</code></td><td><code>[]</code></td><td></td></tr>
<tr><td>None</td><td>Pop from operands</td><td><code>[]</code></td><td><code>[]</code></td><td><code>3</code></td></tr>
</tbody></table>
</div>
<p>Output: <code>3</code></p>
<h3 id="example-2"><a class="header" href="#example-2">Example 2</a></h3>
<p>Input: <code>1 + 2</code></p>
<div class="table-wrapper"><table><thead><tr><th>Token</th><th>Action</th><th>Operands</th><th>Operators</th><th>Value</th><th>Comment</th></tr></thead><tbody>
<tr><td><code>1</code></td><td>Push <code>1</code> to operands</td><td><code>[ 1 ]</code></td><td><code>[]</code></td><td></td><td></td></tr>
<tr><td><code>+</code></td><td>Push <code>+</code> to operators</td><td><code>[ 1 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td><code>2</code></td><td>Push <code>2</code> to operands</td><td><code>[ 2, 1 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td>None</td><td>Process <code>+</code> operator</td><td><code>[ 3 ]</code></td><td><code>[]</code></td><td></td><td><code>1 + 2</code></td></tr>
<tr><td>None</td><td>Pop from operands</td><td><code>[]</code></td><td><code>[]</code></td><td><code>3</code></td><td></td></tr>
</tbody></table>
</div>
<p>Output: <code>3</code></p>
<h3 id="example-3"><a class="header" href="#example-3">Example 3</a></h3>
<p>Input: <code>1 + 2 × 3</code></p>
<div class="table-wrapper"><table><thead><tr><th>Token</th><th>Action</th><th>Operands</th><th>Operators</th><th>Value</th><th>Comment</th></tr></thead><tbody>
<tr><td><code>1</code></td><td>Push <code>1</code> to operands</td><td><code>[ 1 ]</code></td><td><code>[]</code></td><td></td><td></td></tr>
<tr><td><code>+</code></td><td>Push <code>+</code> to operators</td><td><code>[ 1 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td><code>2</code></td><td>Push <code>2</code> to operands</td><td><code>[ 2, 1 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td><code>×</code></td><td>Push <code>×</code> to operators</td><td><code>[ 2, 1 ]</code></td><td><code>[ ×, + ]</code></td><td></td><td></td></tr>
<tr><td><code>3</code></td><td>Push <code>3</code> to operands</td><td><code>[ 3, 2, 1 ]</code></td><td><code>[ ×, + ]</code></td><td></td><td></td></tr>
<tr><td>None</td><td>Process <code>×</code> operator</td><td><code>[ 6, 1 ]</code></td><td><code>[ + ]</code></td><td></td><td><code>2 × 3</code></td></tr>
<tr><td>None</td><td>Process <code>+</code> operator</td><td><code>[ 7 ]</code></td><td><code>[]</code></td><td></td><td><code>1 + 6</code></td></tr>
<tr><td>None</td><td>Pop from operands</td><td><code>[]</code></td><td><code>[]</code></td><td><code>7</code></td><td></td></tr>
</tbody></table>
</div>
<p>Output: <code>7</code></p>
<h3 id="example-4"><a class="header" href="#example-4">Example 4</a></h3>
<p>Input: <code>4 × 5 + 6</code></p>
<div class="table-wrapper"><table><thead><tr><th>Token</th><th>Action</th><th>Operands</th><th>Operators</th><th>Value</th><th>Comment</th></tr></thead><tbody>
<tr><td><code>4</code></td><td>Push <code>4</code> to operands</td><td><code>[ 4 ]</code></td><td><code>[]</code></td><td></td><td></td></tr>
<tr><td><code>×</code></td><td>Push <code>×</code> to operators</td><td><code>[ 4 ]</code></td><td><code>[ × ]</code></td><td></td><td></td></tr>
<tr><td><code>5</code></td><td>Push <code>5</code> to operands</td><td><code>[ 5, 4 ]</code></td><td><code>[ × ]</code></td><td></td><td></td></tr>
<tr><td><code>+</code></td><td>Process <code>×</code> operator</td><td><code>[ 20 ]</code></td><td><code>[]</code></td><td></td><td><code>4 × 5</code></td></tr>
<tr><td><code>+</code></td><td>Push <code>+</code> to operators</td><td><code>[ 20 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td><code>6</code></td><td>Push <code>6</code> to operands</td><td><code>[ 6, 20 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td>None</td><td>Process <code>+</code> operator</td><td><code>[ 26 ]</code></td><td><code>[]</code></td><td></td><td><code>20 + 6</code></td></tr>
<tr><td>None</td><td>Pop from operands</td><td><code>[]</code></td><td><code>[]</code></td><td><code>26</code></td><td></td></tr>
</tbody></table>
</div>
<p>Output: <code>26</code></p>
<h3 id="example-5"><a class="header" href="#example-5">Example 5</a></h3>
<p>Input: <code>3 + 4 × 2 ÷ 4</code></p>
<div class="table-wrapper"><table><thead><tr><th>Token</th><th>Action</th><th>Operands</th><th>Operators</th><th>Value</th><th>Comment</th></tr></thead><tbody>
<tr><td><code>3</code></td><td>Push <code>3</code> to operands</td><td><code>[ 3 ]</code></td><td><code>[]</code></td><td></td><td></td></tr>
<tr><td><code>+</code></td><td>Push <code>+</code> to operators</td><td><code>[ 3 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td><code>4</code></td><td>Push <code>4</code> to operands</td><td><code>[ 4, 3 ]</code></td><td><code>[ + ]</code></td><td></td><td></td></tr>
<tr><td><code>×</code></td><td>Push <code>×</code> to operators</td><td><code>[ 4, 3 ]</code></td><td><code>[ ×, + ]</code></td><td></td><td></td></tr>
<tr><td><code>2</code></td><td>Push <code>2</code> to operands</td><td><code>[ 2, 4, 3 ]</code></td><td><code>[ ×, + ]</code></td><td></td><td></td></tr>
<tr><td><code>÷</code></td><td>Process <code>×</code> operator</td><td><code>[ 8, 3 ]</code></td><td><code>[ + ]</code></td><td></td><td><code>4 × 2</code></td></tr>
<tr><td><code>÷</code></td><td>Push <code>÷</code> to operators</td><td><code>[ 8, 3 ]</code></td><td><code>[ ÷, + ]</code></td><td></td><td></td></tr>
<tr><td><code>4</code></td><td>Push <code>4</code> to operands</td><td><code>[ 4, 8, 3 ]</code></td><td><code>[ ÷, + ]</code></td><td></td><td></td></tr>
<tr><td>None</td><td>Process <code>÷</code> operator</td><td><code>[ 2, 3 ]</code></td><td><code>[ + ]</code></td><td></td><td><code>8 ÷ 4</code></td></tr>
<tr><td>None</td><td>Process <code>+</code> operator</td><td><code>[ 5 ]</code></td><td><code>[]</code></td><td></td><td><code>3 + 2</code></td></tr>
<tr><td>None</td><td>Pop from operands</td><td><code>[]</code></td><td><code>[]</code></td><td><code>5</code></td><td></td></tr>
</tbody></table>
</div>
<p>Output: <code>5</code></p>
<h2 id="translating-the-algorithm-to-elm"><a class="header" href="#translating-the-algorithm-to-elm">Translating the Algorithm to Elm</a></h2>
<h3 id="preamble"><a class="header" href="#preamble">Preamble</a></h3>
<pre><code class="language-elm">module Data.Evaluator exposing (Answer, Error(..), eval)

import Data.Operator exposing (Operator(..))
import Data.Token exposing (Token(..))
import Lib.Rational as Rational exposing (Rational)
import Lib.Stack as Stack exposing (Stack)


type alias Answer =
    Result Error Rational


type Error
    = SyntaxError


eval : List Token -&gt; Answer
eval tokens =
    -- ...
</code></pre>
<p>When evaluating a given infix expression we can either get a syntax error or a rational number.</p>
<p>A syntax error, <code>SyntaxError</code>, is possible if <code>tokens</code> is illegally formed, for e.g.:</p>
<div class="table-wrapper"><table><thead><tr><th><code>tokens</code></th></tr></thead><tbody>
<tr><td><code>[]</code></td></tr>
<tr><td><code>[ Operator Add ]</code></td></tr>
<tr><td><code>[ Number (Rational.fromInt 1), Operator Add ]</code></td></tr>
<tr><td><code>[ Number (Rational.fromInt 1), Number (Rational.fromInt 2) ]</code></td></tr>
</tbody></table>
</div>
<h3 id="dealing-with-mutation"><a class="header" href="#dealing-with-mutation">Dealing with Mutation</a></h3>
<p>The algorithm treats <code>operands</code> and <code>operators</code> as mutable stacks. Since Elm doesn't support mutable data structures we'd have to find another way to change the stacks as the program performs its steps. The typical way we simulate mutability is inputing and outputing a value of the same type. I stored all the global state together in one record type called <code>State</code>:</p>
<pre><code class="language-elm">type alias State =
    { operands : Stack Rational
    , operators : Stack Operator
    }
</code></pre>
<p>To make <code>State</code> easier to work with and "mutate", I implemented the following helper functions:</p>
<pre><code class="language-elm">pushOperand : Rational -&gt; State -&gt; Result Error State
pushOperand q state =
    Ok { state | operands = Stack.push q state.operands }


popOperand : State -&gt; Result Error ( Rational, State )
popOperand state =
    case Stack.pop state.operands of
        Just ( q, operands ) -&gt;
            Ok ( q, { state | operands = operands } )

        Nothing -&gt;
            Err SyntaxError


pushOperator : Operator -&gt; State -&gt; Result Error State
pushOperator op state =
    Ok { state | operators = Stack.push op state.operators }


popOperator : (Operator -&gt; State -&gt; Result Error State) -&gt; (State -&gt; Result Error State) -&gt; State -&gt; Result Error State
popOperator onOperator onEmpty state =
    case Stack.pop state.operators of
        Just ( op, operators ) -&gt;
            onOperator op { state | operators = operators }

        Nothing -&gt;
            onEmpty state
</code></pre>
<h3 id="initialization"><a class="header" href="#initialization">Initialization</a></h3>
<p>From the algorithm:</p>
<pre><code>eval(tokens: List of Token) -&gt; Rational or Error
  -- Initialization

  operands = Stack.empty()
  operators = Stack.empty()

  -- Process the tokens

  for t in tokens do
    -- ...
  end for

  -- Process the operators
  -- Return the value
end
</code></pre>
<p>Translated to Elm:</p>
<pre><code class="language-elm">eval : List Token -&gt; Answer
eval tokens =
    let
        -- Initialization

        state =
            { operands = Stack.new
            , operators = Stack.new
            }
    in
    -- Process the tokens
    -- Process the operators

    evalTokens tokens state
        |&gt; Result.andThen
            (\{ operands, operators } -&gt;
                -- Return the value
            )
</code></pre>
<h3 id="process-the-tokens"><a class="header" href="#process-the-tokens">Process the Tokens</a></h3>
<p>From the algorithm:</p>
<pre><code>-- Process the tokens

for t in tokens do
  if t is a number, n then
    operands.push(n)

  else if t is an operator, op1 then
    -- Evaluate the dominant operators
  end if
end for

-- Process the operators
-- Return the value
</code></pre>
<p>Translated to Elm:</p>
<pre><code class="language-elm">evalTokens : List Token -&gt; State -&gt; Result Error State
evalTokens tokens state =
    case tokens of
        [] -&gt;
            -- Process the operators

            evalOperators state

        token :: restTokens -&gt;
            evalToken token state
                |&gt; Result.andThen (evalTokens restTokens)


evalToken : Token -&gt; State -&gt; Result Error State
evalToken token state =
    case token of
        Number n -&gt;
            pushOperand n state

        Operator op -&gt;
            -- Evaluate the dominant operators

            evalDominantOperators op state
</code></pre>
<h3 id="evaluate-the-dominant-operators"><a class="header" href="#evaluate-the-dominant-operators">Evaluate the Dominant Operators</a></h3>
<p>From the algorithm:</p>
<pre><code>-- Evaluate the dominant operators

while operators.isNotEmpty() do
  op2 = operators.top()

  if precendence(op2) &gt;= precendence(op1) then
    op2 = operators.pop()
    evalBinOp(op2, operands)

  else
    break
  end if
end while

operators.push(op1)
</code></pre>
<p>And, <code>evalBinOp</code> from the algorithm:</p>
<pre><code>evalBinOp(op: Operator, operands: Stack of Rational) -&gt; () or Error
  if operands.isEmpty() then
    raise an error
  end if

  b = operands.pop()

  if operands.isEmpty() then
    raise an error
  end if

  a = operands.pop()

  if op is addition then
    operands.push(a + b)

  else if op is subtraction then
    operands.push(a - b)

  else if op is multiplication then
    operands.push(a × b)

  else if op is division then
    operands.push(a ÷ b)
  end if
end
</code></pre>
<p>Translated to Elm:</p>
<pre><code class="language-elm">evalDominantOperators : Operator -&gt; State -&gt; Result Error State
evalDominantOperators op1 state0 =
    popOperator
        (\op2 state1 -&gt;
            if precedence op2 &gt;= precedence op1 then
                evalOperation op2 state1
                    |&gt; Result.andThen (evalDominantOperators op1)

            else
                pushOperator op1 state0
        )
        (pushOperator op1)
        state0


evalOperation : Operator -&gt; State -&gt; Result Error State
evalOperation op state0 =
    popOperand state0
        |&gt; Result.andThen
            (\( right, state1 ) -&gt;
                popOperand state1
                    |&gt; Result.andThen
                        (\( left, state2 ) -&gt;
                            evalBinOp op left right state2
                        )
            )


evalBinOp : Operator -&gt; Rational -&gt; Rational -&gt; State -&gt; Result Error State
evalBinOp op a b =
    pushOperand &lt;|
        case op of
            Add -&gt;
                Rational.add a b

            Sub -&gt;
                Rational.sub a b

            Mul -&gt;
                Rational.mul a b

            Div -&gt;
                Rational.div a b
</code></pre>
<h3 id="process-the-operators"><a class="header" href="#process-the-operators">Process the Operators</a></h3>
<p>From the algorithm:</p>
<pre><code>-- Process the operators

while operators.isNotEmpty() do
  op = operators.pop()
  evalBinOp(op, operands)
end while
</code></pre>
<p>Translated to Elm:</p>
<pre><code class="language-elm">evalOperators : State -&gt; Result Error State
evalOperators state0 =
    popOperator
        (\op state1 -&gt;
            evalOperation op state1
                |&gt; Result.andThen evalOperators
        )
        (\state1 -&gt; Ok state1)
        state0
</code></pre>
<p>This can be simplified to:</p>
<pre><code class="language-elm">evalOperators : State -&gt; Result Error State
evalOperators =
    popOperator
        (\op -&gt; evalOperation op &gt;&gt; Result.andThen evalOperators)
        Ok
</code></pre>
<h3 id="return-the-value"><a class="header" href="#return-the-value">Return the Value</a></h3>
<p>From the algorithm:</p>
<pre><code>-- Return the value

if operands.isEmpty() then
  raise an error
end if

value = operands.pop()

if operands.isEmpty() then
  return value

else
  raise an error
end if
</code></pre>
<p>Translated to Elm:</p>
<pre><code class="language-elm">case ( Stack.pop operands, Stack.isEmpty operators ) of
    ( Just ( value, newOperands ), True ) -&gt;
        if Stack.isEmpty newOperands then
            Ok value

        else
            Err SyntaxError

    _ -&gt;
        Err SyntaxError
</code></pre>
<h2 id="all-together"><a class="header" href="#all-together">All Together</a></h2>
<pre><code class="language-elm">module Data.Evaluator exposing (Answer, Error(..), eval)

import Data.Operator exposing (Operator(..))
import Data.Token exposing (Token(..))
import Lib.Rational as Rational exposing (Rational)
import Lib.Stack as Stack exposing (Stack)


type alias Answer =
    Result Error Rational


type Error
    = SyntaxError


type alias State =
    { operands : Stack Rational
    , operators : Stack Operator
    }


eval : List Token -&gt; Answer
eval tokens =
    let
        state =
            { operands = Stack.new
            , operators = Stack.new
            }
    in
    evalTokens tokens state
        |&gt; Result.andThen
            (\{ operands, operators } -&gt;
                case ( Stack.pop operands, Stack.isEmpty operators ) of
                    ( Just ( value, newOperands ), True ) -&gt;
                        if Stack.isEmpty newOperands then
                            Ok value

                        else
                            Err SyntaxError

                    _ -&gt;
                        Err SyntaxError
            )


evalTokens : List Token -&gt; State -&gt; Result Error State
evalTokens tokens state =
    case tokens of
        [] -&gt;
            evalOperators state

        token :: restTokens -&gt;
            evalToken token state
                |&gt; Result.andThen (evalTokens restTokens)


evalToken : Token -&gt; State -&gt; Result Error State
evalToken token state =
    case token of
        Number n -&gt;
            pushOperand n state

        Operator op -&gt;
            evalDominantOperators op state


evalDominantOperators : Operator -&gt; State -&gt; Result Error State
evalDominantOperators op1 state0 =
    popOperator
        (\op2 state1 -&gt;
            if precedence op2 &gt;= precedence op1 then
                evalOperation op2 state1
                    |&gt; Result.andThen (evalDominantOperators op1)

            else
                pushOperator op1 state0
        )
        (pushOperator op1)
        state0


evalOperators : State -&gt; Result Error State
evalOperators =
    popOperator
        (\op -&gt; evalOperation op &gt;&gt; Result.andThen evalOperators)
        Ok


evalOperation : Operator -&gt; State -&gt; Result Error State
evalOperation op state0 =
    popOperand state0
        |&gt; Result.andThen
            (\( right, state1 ) -&gt;
                popOperand state1
                    |&gt; Result.andThen
                        (\( left, state2 ) -&gt;
                            evalBinOp op left right state2
                        )
            )


evalBinOp : Operator -&gt; Rational -&gt; Rational -&gt; State -&gt; Result Error State
evalBinOp op a b =
    pushOperand &lt;|
        case op of
            Add -&gt;
                Rational.add a b

            Sub -&gt;
                Rational.sub a b

            Mul -&gt;
                Rational.mul a b

            Div -&gt;
                Rational.div a b


pushOperand : Rational -&gt; State -&gt; Result Error State
pushOperand q state =
    Ok { state | operands = Stack.push q state.operands }


popOperand : State -&gt; Result Error ( Rational, State )
popOperand state =
    case Stack.pop state.operands of
        Just ( q, operands ) -&gt;
            Ok ( q, { state | operands = operands } )

        Nothing -&gt;
            Err SyntaxError


pushOperator : Operator -&gt; State -&gt; Result Error State
pushOperator op state =
    Ok { state | operators = Stack.push op state.operators }


popOperator : (Operator -&gt; State -&gt; Result Error State) -&gt; (State -&gt; Result Error State) -&gt; State -&gt; Result Error State
popOperator onOperator onEmpty state =
    case Stack.pop state.operators of
        Just ( op, operators ) -&gt;
            onOperator op { state | operators = operators }

        Nothing -&gt;
            onEmpty state


precedence : Operator -&gt; Int
precedence op =
    case op of
        Add -&gt;
            1

        Sub -&gt;
            1

        Mul -&gt;
            2

        Div -&gt;
            2
</code></pre>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<ul>
<li><a href="https://github.com/dwayne/elm-calculator/blob/1.0.0/src/Data/Evaluator.elm">src/Data/Evaluator.elm</a></li>
<li><a href="https://github.com/dwayne/elm-calculator/blob/1.0.0/src/Data/Token.elm">src/Data/Token.elm</a></li>
<li><a href="https://github.com/dwayne/elm-calculator/blob/1.0.0/src/Data/Operator.elm">src/Data/Operator.elm</a></li>
<li><a href="https://github.com/dwayne/elm-calculator/blob/1.0.0/src/Lib/Stack.elm">src/Lib/Stack.elm</a></li>
<li><a href="https://github.com/dwayne/elm-calculator/blob/1.0.0/src/Lib/Rational.elm">src/Lib/Rational.elm</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../application-logic/evaluating-infix-expressions/stack.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../application-logic/evaluating-infix-expressions/unit-tests.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../application-logic/evaluating-infix-expressions/stack.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../application-logic/evaluating-infix-expressions/unit-tests.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
